# frontend-staging.yml
# Kelix Frontend — Staging CI/CD (PR validation + staging deploy)
#
# Behavior:
# - PR to staging: Build + Test + Security
# - Push to staging: Build + Test + Security + Publish Artifact + Deploy to Staging

trigger:
  branches:
    include:
      - staging

pr:
  branches:
    include:
      - staging

pool:
  vmImage: ubuntu-24.04

variables:
  NODE_VERSION: '20.x'
  FRONTEND_APP_LOCATION: 'app'
  FRONTEND_DIST_LOCATION: 'app/dist'
  PNPM_STORE_PATH: $(Pipeline.Workspace)/.pnpm-store
  CACHE_RESTORED: false

stages:
  # -------------------------
  # Stage 1 — Build (CI Build)
  # -------------------------
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build Frontend
        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: Use Node.js $(NODE_VERSION)
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: npm install -g pnpm@10.15.1
            displayName: Install pnpm 10.15.1

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(FRONTEND_APP_LOCATION)/pnpm-lock.yaml'
              path: $(PNPM_STORE_PATH)
              cacheHitVar: CACHE_RESTORED

          - script: |
              pnpm config set store-dir $(PNPM_STORE_PATH)
            displayName: Configure pnpm store

          - script: |
              cd $(FRONTEND_APP_LOCATION)
              pnpm install --frozen-lockfile
              pnpm run build
            displayName: Install dependencies and build

          # Publish build output
          - task: PublishPipelineArtifact@1
            displayName: Publish build output (dist) as artifact
            inputs:
              targetPath: $(FRONTEND_DIST_LOCATION)
              artifact: frontend-dist
              publishLocation: pipeline


  # -------------------------
  # Stage 2 — Test (CI Quality Gate)
  # -------------------------
  - stage: Test
    displayName: Test
    dependsOn: Build
    jobs:
      - job: Test
        displayName: Lint and Tests
        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: Use Node.js $(NODE_VERSION)
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: npm install -g pnpm@10.15.1
            displayName: Install pnpm 10.15.1

          - task: Cache@2
            displayName: Restore pnpm store cache
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(FRONTEND_APP_LOCATION)/pnpm-lock.yaml'
              path: $(PNPM_STORE_PATH)
              cacheHitVar: CACHE_RESTORED

          - script: |
              pnpm config set store-dir $(PNPM_STORE_PATH)
            displayName: Configure pnpm store

          - script: |
              cd $(FRONTEND_APP_LOCATION)
              pnpm install --frozen-lockfile
            displayName: Install dependencies


          - script: |
              cd $(FRONTEND_APP_LOCATION)
              pnpm run lint
            displayName: Run lint and tests


  # -------------------------
  # Stage 3 — Security (Shift-left Security)
  #   - SAST (Static Application Security Testing)
  #   - SCA (Software Composition Analysis -> dependency/vulnerability scanning)
  #   - Secrets scanning
  #   - SBOM generation
  # -------------------------
 
  - stage: Security
    displayName: Security Scans
    dependsOn: Test
    jobs:
      - job: Security
        displayName: Run Security Controls
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'

          # Use same Node version
          - task: NodeTool@0
            displayName: Use Node.js $(NODE_VERSION)
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: npm install -g pnpm@10.15.1
            displayName: Install pnpm 10.15.1

          - task: Cache@2
            displayName: Restore pnpm store cache
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(FRONTEND_APP_LOCATION)/pnpm-lock.yaml'
              path: $(PNPM_STORE_PATH)
              cacheHitVar: CACHE_RESTORED

          - script: |
              pnpm config set store-dir $(PNPM_STORE_PATH)
            displayName: Configure pnpm store

          - script: |
              cd $(FRONTEND_APP_LOCATION)
              pnpm install --frozen-lockfile
            displayName: Install dependencies

          # -------------------------
          # SAST — Semgrep
          # -------------------------
          - script: |
              pip install semgrep==1.148.0
              cd $(FRONTEND_APP_LOCATION)
              semgrep ci --config auto
            displayName: SAST - Semgrep Scan


          # -------------------------
          # SCA — pnpm audit
          # -------------------------
          - script: |
              cd $(FRONTEND_APP_LOCATION)
              pnpm audit --audit-level high
            displayName: SCA - pnpm audit

          # -------------------------
          # Secrets Scanning — Gitleaks
          # -------------------------
          - script: |
              wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.30.0/gitleaks_8.30.0_linux_x64.tar.gz
              tar -xzf gitleaks_8.30.0_linux_x64.tar.gz
              sudo mv gitleaks /usr/local/bin/gitleaks
              gitleaks detect --source . --redact --exit-code 1
            displayName: Secrets Scan - Gitleaks

          # -------------------------
          # SBOM — CycloneDX (cdxgen)
          # -------------------------
          - script: |
              cd $(FRONTEND_APP_LOCATION)
              npm install -g @cyclonedx/cdxgen@12.0.0
              cdxgen -o sbom.json
            displayName: Generate SBOM


          # Publish SBOM artifact
          - task: PublishPipelineArtifact@1
            displayName: Publish SBOM
            inputs:
              targetPath: $(FRONTEND_APP_LOCATION)/sbom.json
              artifact: sbom
              publishLocation: pipeline

  # -------------------------
  # Stage 4 — Deploy to Staging (CD Non-Prod)
  # -------------------------

  - stage: Deploy_Staging
    displayName: Deploy to Staging
    dependsOn: Security
    condition: and(
        succeeded(),
        or(
          eq(variables['Build.SourceBranch'], 'refs/heads/staging'),
          eq(variables['Build.Reason'], 'Manual')
        )
      )
    jobs:
      - deployment: FrontendStaging
        displayName: Frontend - Deploy to Kelix Staging
        environment: Kelix-Staging
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend-dist
                  displayName: Download frontend-dist artifact

                - script: |
                    echo "Pipeline Workspace: $(Pipeline.Workspace)"
                    ls -la $(Pipeline.Workspace)
                    echo "---"
                    echo "Frontend-dist contents:"
                    ls -la $(Pipeline.Workspace)/frontend-dist
                  displayName: Debug - Show artifact structure

                # Deploy the artifact without rebuilding (skip_app_build: true)
                # AzureStaticWebApp expects a folder path containing the built static assets.
                - task: AzureStaticWebApp@0
                  displayName: Deploy to Azure Static Web Apps (Staging)
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend-dist'
                    output_location: ''
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(DEPLOYMENT_TOKEN_STATIC_STAGING)

